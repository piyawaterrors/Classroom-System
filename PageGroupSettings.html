<!-- Group Settings Panel -->
<div class="p-6">
  <!-- Header -->
  <div
    class="flex items-center gap-2 mb-4 text-indigo-500 text-xs font-bold uppercase tracking-wider"
  >
    <i class="fa-solid fa-sliders"></i> การตั้งค่ากลุ่มเรียน
  </div>

  <!-- Add New Group Form -->
  <div
    class="bg-white/50 p-4 rounded-2xl border border-slate-100 shadow-sm mb-6"
  >
    <div class="space-y-3">
      <div>
        <label class="text-[10px] text-slate-400 font-bold ml-1 uppercase"
          >ชื่อกลุ่มเรียน</label
        >
        <input
          type="text"
          id="newGroupName"
          placeholder="Ex. CS101 Section 1"
          class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition"
        />
      </div>
      <div>
        <label class="text-[10px] text-slate-400 font-bold ml-1 uppercase"
          >Spreadsheet ID</label
        >
        <input
          type="text"
          id="newSheetId"
          placeholder="1xXx... (ID จาก URL)"
          class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-xs font-mono focus:ring-2 focus:ring-indigo-500 outline-none transition"
        />
      </div>
      <button
        type="button"
        onclick="addGroup()"
        class="w-full btn-primary flex items-center justify-center gap-2 py-2.5 rounded-xl text-sm"
      >
        <i class="fa-solid fa-plus"></i> บันทึกกลุ่ม
      </button>
    </div>
  </div>

  <!-- Group List Header -->
  <div
    class="mb-3 text-xs font-bold text-slate-400 uppercase tracking-wider flex justify-between items-center"
  >
    <span>รายวิชาที่มี</span>
    <span
      class="bg-slate-200 text-slate-500 px-2 py-0.5 rounded-md text-[10px]"
      id="groupCount"
      >0</span
    >
  </div>

  <!-- Group List -->
  <ul id="groupList" class="space-y-2 pb-4 max-h-96 overflow-y-auto"></ul>
</div>

<script>
  let groupsData = [];

  // Load groups on init
  (function () {
    loadGroups();
  })();

  function loadGroups() {
    google.script.run.withSuccessHandler(renderGroups).getGroups();
  }

  function renderGroups(data) {
    groupsData = data;
    const list = document.getElementById("groupList");
    document.getElementById("groupCount").innerText = data.length;
    list.innerHTML = "";

    data.forEach((g, i) => {
      list.innerHTML += `
        <li class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm group hover:border-indigo-300 transition mb-2">
          <div class="flex items-center gap-3 overflow-hidden cursor-pointer w-full" onclick="openEditModal(${i})">
            <div class="bg-indigo-50 text-indigo-600 w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shrink-0 transition group-hover:bg-indigo-600 group-hover:text-white group-hover:shadow-md">
              <i class="fa-solid fa-pen"></i>
            </div>
            <div class="flex flex-col truncate">
              <span class="text-sm font-bold text-slate-700 truncate group-hover:text-indigo-600 transition">${
                g.name
              }</span>
              <span class="text-[10px] text-slate-400 font-mono truncate">ID: ${g.id.substring(
                0,
                8
              )}...</span>
            </div>
          </div>
          <button 
            type="button" 
            onclick="delGroup(${i})" 
            class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-300 hover:text-rose-500 hover:bg-rose-50 transition ml-2"
          >
            <i class="fa-solid fa-trash"></i>
          </button>
        </li>
      `;
    });

    // Trigger event to update other pages
    if (window.parent && window.parent.onGroupsUpdated) {
      window.parent.onGroupsUpdated(data);
    }
  }

  function addGroup() {
    const name = document.getElementById("newGroupName").value;
    const id = document.getElementById("newSheetId").value;

    if (!name || !id) {
      if (window.parent && window.parent.showToast) {
        window.parent.showToast("กรุณากรอกข้อมูลให้ครบ", "error");
      } else {
        alert("กรุณากรอกข้อมูลให้ครบ");
      }
      return;
    }

    google.script.run
      .withSuccessHandler((res) => {
        if (res.success) {
          renderGroups(res.data);
          document.getElementById("newGroupName").value = "";
          document.getElementById("newSheetId").value = "";
          if (window.parent && window.parent.showToast) {
            window.parent.showToast("บันทึกกลุ่มเรียบร้อย");
          }
        } else {
          if (window.parent && window.parent.showToast) {
            window.parent.showToast(res.msg, "error");
          } else {
            alert(res.msg);
          }
        }
      })
      .saveGroup(name, id);
  }

  function openEditModal(i) {
    if (window.parent && window.parent.openEditModalFromSettings) {
      window.parent.openEditModalFromSettings(i, groupsData[i]);
    }
  }

  function delGroup(i) {
    if (window.parent && window.parent.confirmDeleteGroup) {
      window.parent.confirmDeleteGroup(i, () => {
        google.script.run
          .withSuccessHandler((res) => {
            if (res.success) {
              renderGroups(res.data);
              if (window.parent && window.parent.showToast) {
                window.parent.showToast("ลบข้อมูลเรียบร้อย");
              }
            }
          })
          .deleteGroup(i);
      });
    }
  }
</script>
